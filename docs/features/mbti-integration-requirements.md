# MBTI統合機能 要件定義

## 1. 背景と目的
- ユーザーのMBTI (Myers-Briggs Type Indicator) 性格タイプを保存し、AIチャット応答のパーソナライズに活用する。
- フロントエンドからMBTIを登録し、AIがユーザーの性格タイプに応じた適切なコミュニケーションスタイルで返答できるようにする。
- MBTIが未設定のユーザーには、従来通り標準的な応答を提供する。

## 2. 想定利用者 / クライアント
- RetentionEngine のフロントエンド (プロフィール設定ビュー、チャットビュー)
- NEW_HIRE ロールのユーザーが自身のMBTIを登録・更新できる
- Mentorは参考情報として閲覧できる可能性がある (将来的な拡張)

## 3. 認証・権限
- **MBTIの登録/更新**: `NEW_HIRE` ロールのユーザーのみが自分自身のMBTIを登録・更新可能
- **MBTIの参照**: 本人と担当メンター (将来的に実装予定)
- セッション Cookie (`auth_access_token`) または Bearer Token で認証

## 4. エンドポイント仕様

### 4.1 MBTI登録・更新エンドポイント

| Method | Path | 概要 |
| --- | --- | --- |
| `PUT` | `/user/mbti` | 自分のMBTIタイプを登録または更新する (アップサート) |

- 既存値があれば上書き、未設定なら新規登録。MBTIの再診断などで値が変わる場合もこのエンドポイントを使用する。

#### リクエスト
- **ヘッダー**: `Content-Type: application/json`, 認証ヘッダー or Cookie
- **Body**
  ```json
  {
    "mbti": "INTJ"
  }
  ```
  - `mbti`: 16種類のMBTIタイプのいずれか (大文字4文字)
    - 有効な値: `INTJ`, `INTP`, `ENTJ`, `ENTP`, `INFJ`, `INFP`, `ENFJ`, `ENFP`, `ISTJ`, `ISFJ`, `ESTJ`, `ESFJ`, `ISTP`, `ISFP`, `ESTP`, `ESFP`

#### レスポンス
- **成功 (HTTP 200)**
  ```json
  {
    "message": "MBTI updated successfully"
  }
  ```
  - 成功後の値確認は `GET /user/mbti` で取得する。

- **エラー**
  | ステータス | 条件 | 例 |
  | --- | --- | --- |
  | 400 | 不正なMBTIタイプ / 必須項目欠如 | `{ "error": "Invalid MBTI type. Must be one of 16 valid types." }` |
  | 401 | 未ログイン / トークン無効 | `{ "error": "Unauthorized" }` |
  | 403 | ロールが許可されていない | `{ "error": "Forbidden" }` |
  | 500 | データベース更新失敗 | `{ "error": "Failed to update MBTI." }` |

### 4.2 MBTI取得エンドポイント

| Method | Path | 概要 |
| --- | --- | --- |
| `GET` | `/user/mbti` | 自分のMBTIタイプを取得する |

#### リクエスト
- **ヘッダー**: 認証ヘッダー or Cookie
- **Body**: なし

#### レスポンス
- **成功 (HTTP 200)**
  ```json
  {
    "mbti": "INTJ"
  }
  ```
  または、未設定の場合
  ```json
  {
    "mbti": null
  }
  ```

- **エラー**
  | ステータス | 条件 | 例 |
  | --- | --- | --- |
  | 401 | 未ログイン / トークン無効 | `{ "error": "Unauthorized" }` |
  | 404 | ユーザーが存在しない | `{ "error": "User not found" }` |
  | 500 | データベース取得失敗 | `{ "error": "Failed to fetch MBTI." }` |

## 5. データベーススキーマ変更

### user テーブルへの追加カラム
```sql
ALTER TABLE user ADD COLUMN mbti VARCHAR(4) NULL;
```

- **カラム名**: `mbti`
- **型**: `VARCHAR(4)` または `TEXT` (Supabaseの場合)
- **制約**: NULL許可 (未設定のユーザーがいるため)
- **初期値**: `NULL`

## 6. LLM統合: プロンプトへのMBTI情報追加

### 6.1 処理フロー
1. ユーザーがチャットメッセージを送信
2. LLMService の `generate()` メソッドで、ユーザーIDからMBTI情報を取得
3. MBTIが設定されている場合、システムプロンプトにMBTIに基づいたコミュニケーションスタイルの指示を追加
4. MBTIが未設定の場合、従来通りの標準プロンプトを使用

### 6.2 MBTIベースのプロンプト拡張例

#### MBTI別コミュニケーションスタイル例

```typescript
const MBTI_COMMUNICATION_STYLES = {
  // アナリスト型
  INTJ: "論理的で構造化された説明を好みます。直接的で効率的なコミュニケーションを心がけてください。",
  INTP: "理論的背景や根拠を重視します。詳細な説明と複数の視点を提供してください。",
  ENTJ: "効率と結果を重視します。明確で行動指向のアドバイスを提供してください。",
  ENTP: "創造的で多角的なアプローチを好みます。議論を促すような質問を含めてください。",
  
  // 外交官型
  INFJ: "深い洞察と意味を求めます。共感的で思慮深い応答を心がけてください。",
  INFP: "価値観と調和を重視します。支援的で温かみのある言葉遣いを使用してください。",
  ENFJ: "協力と人間関係を大切にします。励ましとポジティブなフィードバックを提供してください。",
  ENFP: "熱意と可能性を重視します。インスピレーションを与える表現を使用してください。",
  
  // 番人型
  ISTJ: "事実と実用性を重視します。具体的で段階的な説明を提供してください。",
  ISFJ: "安定と支援を求めます。丁寧で思いやりのある言葉遣いを心がけてください。",
  ESTJ: "秩序と効率を重視します。明確で組織化された情報を提供してください。",
  ESFJ: "調和と協力を大切にします。温かく支援的な応答を心がけてください。",
  
  // 探検家型
  ISTP: "実践的な解決策を好みます。簡潔で具体的なアドバイスを提供してください。",
  ISFP: "柔軟性と個性を重視します。優しく非強制的な表現を使用してください。",
  ESTP: "行動と結果を重視します。ダイナミックで実践的なアドバイスを提供してください。",
  ESFP: "楽しさと活気を大切にします。親しみやすくエネルギッシュな応答を心がけてください。"
};
```

#### システムプロンプトへの統合例
```typescript
const baseSystemPrompt = "あなたは新入社員をサポートするメンターアシスタントです。";

let systemPrompt = baseSystemPrompt;
if (userMbti) {
  const communicationStyle = MBTI_COMMUNICATION_STYLES[userMbti];
  systemPrompt += `\n\nこのユーザーのMBTIタイプは${userMbti}です。${communicationStyle}`;
}
```

## 7. 実装の優先順位とフェーズ

### Phase 0: テスト準備 (先行)
1. `PUT /user/mbti` と `GET /user/mbti` のAPIコントラクトテストを作成 (認証モック/テストユーザー用シード込み)  
   - フロント未接続でもエンドポイントをすぐ検証できるようにする。
2. MBTIバリデーションのユニットテスト作成 (16種類/それ以外)
3. `user.types.ts` のユーザークラスのコンストラクタバリデーションをユニットテスト (正常/異常)

### Phase 1: データモデルとAPI (必須)
1. データベーススキーマ変更 (user テーブルに mbti カラム追加)
2. User型にMBTIフィールド追加
3. MBTI登録・更新API (`PUT /user/mbti`) 実装
4. MBTI取得API (`GET /user/mbti`) 実装
5. バリデーション機能 (16種類のMBTIタイプチェック)
6. `user.types.ts` を interface から class に変更し、ユーザー周辺のロジックを集約  
   - コンストラクタで入力オブジェクトを検証し、MBTIは16種類/大文字4文字またはnullのみ受け付ける。  
   - `static create(rawUser: UserInput): User` (名称は実装に合わせて調整) のようなファクトリを用意し、引数で受け取ったプレーンなUserオブジェクトを内部で新規インスタンス化して返す。  
   - ユーザー追加などのUserオブジェクトに近い処理はこのクラスに実装し、バリデーションと生成処理を一本化する。

### Phase 2: LLM統合 (コア機能)
1. UserServiceにMBTI取得メソッド追加
2. LlmServiceの`generate()`メソッドにMBTI取得ロジック追加
3. MBTI別コミュニケーションスタイル定義
4. システムプロンプトへのMBTI情報統合
5. MBTIがnullの場合のフォールバック処理

### Phase 3: フロントエンド連携 (別リポジトリ)
1. プロフィール設定画面でMBTI選択UI実装
2. API呼び出し処理実装
3. チャット画面でのMBTI表示 (オプション)

## 8. 非機能要件

- **パフォーマンス**: MBTI取得はユーザー情報取得と同時に行い、追加のDB問い合わせを最小化
- **データ整合性**: MBTIタイプのバリデーションを厳格に行い、不正な値の保存を防止
- **プライバシー**: MBTIは個人情報として扱い、ログには記録しない
- **後方互換性**: MBTIが未設定のユーザーでも既存機能が正常に動作すること

## 9. テスト要件

### ユニットテスト
- MBTIバリデーション (有効/無効なタイプ)
- MBTI更新処理 (成功/失敗ケース)
- プロンプト生成ロジック (MBTI有り/無し)

### E2Eテスト
- MBTI登録フロー
- MBTI取得フロー
- MBTIを含むチャット応答生成

## 10. 今後の拡張可能性

- メンターがメンティーのMBTIを閲覧できる機能
- MBTIに基づいたメンター・メンティーのマッチング提案
- MBTI別の応答品質分析とプロンプトチューニング
- ユーザーが複数回MBTI診断を受けた場合の履歴管理
- MBTI以外の性格診断ツールとの統合 (Big Five等)

## 11. 成功指標

- MBTI登録率: アクティブユーザーの50%以上がMBTIを登録
- ユーザー満足度: MBTIベースの応答に対する肯定的フィードバック率の向上
- エンゲージメント: MBTI設定ユーザーのチャット継続率の向上
