# RAG Cache Flow Diagrams

## 1. Request Flow - Cache Hit Scenarios

### 1.1 Best Case: L1 Cache Hit (<1ms)

```
User Request
     â”‚
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         LlmService.generate()               â”‚
â”‚                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  EnhancedInMemoryCacheService      â”‚    â”‚
â”‚  â”‚  getOrCreateFileSearchAnswer()     â”‚    â”‚
â”‚  â”‚                                     â”‚    â”‚
â”‚  â”‚  1. Generate cache key:             â”‚    â”‚
â”‚  â”‚     hash(query + conversationId)   â”‚    â”‚
â”‚  â”‚                                     â”‚    â”‚
â”‚  â”‚  2. Check fileSearchExactCache     â”‚    â”‚
â”‚  â”‚     âœ… HIT!                         â”‚    â”‚
â”‚  â”‚                                     â”‚    â”‚
â”‚  â”‚  3. Return cached result            â”‚    â”‚
â”‚  â”‚     Latency: <1ms                   â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â–¼
              Response to User
              Total Time: <1ms
```

**Key Characteristics**:
- âš¡ Sub-millisecond response
- ğŸ’¾ No external API calls
- ğŸ¯ Exact query match

---

### 1.2 Good Case: L2 Semantic Cache Hit (5-10ms)

```
User Request: "æ–°äººç ”ä¿®ã®äºˆå®šã¯ï¼Ÿ"
     â”‚
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              LlmService.generate()                          â”‚
â”‚                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  L1: EnhancedInMemoryCacheService                  â”‚    â”‚
â”‚  â”‚  1. Check fileSearchExactCache                     â”‚    â”‚
â”‚  â”‚     âŒ MISS (exact query not found)                â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                   â”‚                                          â”‚
â”‚                   â–¼                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  L2: SemanticCacheService.findSimilar()            â”‚    â”‚
â”‚  â”‚                                                     â”‚    â”‚
â”‚  â”‚  1. Embed query with text-embedding-005:          â”‚    â”‚
â”‚  â”‚     "æ–°äººç ”ä¿®ã®äºˆå®šã¯ï¼Ÿ" â†’ [768-dim vector]         â”‚    â”‚
â”‚  â”‚     Latency: 50-100ms                              â”‚    â”‚
â”‚  â”‚                                                     â”‚    â”‚
â”‚  â”‚  2. Redis Vector Similarity Search:                â”‚    â”‚
â”‚  â”‚     FT.SEARCH ... KNN 5 ...                        â”‚    â”‚
â”‚  â”‚     Latency: 2-5ms                                 â”‚    â”‚
â”‚  â”‚                                                     â”‚    â”‚
â”‚  â”‚  3. Find similar cached query:                     â”‚    â”‚
â”‚  â”‚     "æ–°äººç ”ä¿®ã®ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«" (similarity: 0.94)     â”‚    â”‚
â”‚  â”‚     âœ… HIT!                                         â”‚    â”‚
â”‚  â”‚                                                     â”‚    â”‚
â”‚  â”‚  4. Return cached result                            â”‚    â”‚
â”‚  â”‚     Total L2 Latency: 50-100ms (embed) + 2-5ms     â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                   â”‚                                          â”‚
â”‚                   â–¼                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  L1: Write-back promotion                          â”‚    â”‚
â”‚  â”‚  Store result in fileSearchExactCache              â”‚    â”‚
â”‚  â”‚  (for future exact matches)                        â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â–¼
                  Response to User
                  Total Time: 55-105ms
```

**Key Characteristics**:
- ğŸ§  Semantic understanding (é¡ä¼¼ã‚¯ã‚¨ãƒªã‚’ãƒãƒƒãƒãƒ³ã‚°)
- âš¡ Still fast (<100ms)
- ğŸ’¡ Learns from past queries

---

### 1.3 Acceptable Case: L3 Firestore Hit (50-100ms)

```
User Request
     â”‚
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              LlmService.generate()                         â”‚
â”‚                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  L1: EnhancedInMemoryCacheService                 â”‚    â”‚
â”‚  â”‚  âŒ MISS                                           â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                   â”‚                                         â”‚
â”‚                   â–¼                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  L2: SemanticCacheService                         â”‚    â”‚
â”‚  â”‚  âŒ MISS (no similar queries found)               â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                   â”‚                                         â”‚
â”‚                   â–¼                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  L3: PersistentCacheService.find()                â”‚    â”‚
â”‚  â”‚                                                    â”‚    â”‚
â”‚  â”‚  1. Firestore query:                              â”‚    â”‚
â”‚  â”‚     collection('filesearch_cache')                â”‚    â”‚
â”‚  â”‚     .doc(cacheKey)                                â”‚    â”‚
â”‚  â”‚     Latency: 50-100ms                             â”‚    â”‚
â”‚  â”‚                                                    â”‚    â”‚
â”‚  â”‚  2. Check TTL:                                    â”‚    â”‚
â”‚  â”‚     expiresAt > Date.now() âœ…                     â”‚    â”‚
â”‚  â”‚                                                    â”‚    â”‚
â”‚  â”‚  3. Return cached result                          â”‚    â”‚
â”‚  â”‚     âœ… HIT!                                        â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                   â”‚                                         â”‚
â”‚                   â–¼                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  Write-through promotion:                         â”‚    â”‚
â”‚  â”‚  L3 â†’ L2 (Redis) â†’ L1 (InMemory)                 â”‚    â”‚
â”‚  â”‚  (Async, non-blocking)                            â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â–¼
                  Response to User
                  Total Time: 50-100ms
```

**Key Characteristics**:
- ğŸ’¾ Long-term storage retrieval
- ğŸ”„ Auto-promotion to hot cache
- ğŸ“Š Analytics data collection

---

### 1.4 Cold Start: FileSearch API Call (15-20s)

```
User Request: [New/Unique Query]
     â”‚
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              LlmService.generate()                         â”‚
â”‚                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  L1: EnhancedInMemoryCacheService                 â”‚    â”‚
â”‚  â”‚  âŒ MISS                                           â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                   â”‚                                         â”‚
â”‚                   â–¼                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  L2: SemanticCacheService                         â”‚    â”‚
â”‚  â”‚  âŒ MISS (no similar queries)                     â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                   â”‚                                         â”‚
â”‚                   â–¼                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  L3: PersistentCacheService                       â”‚    â”‚
â”‚  â”‚  âŒ MISS                                           â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                   â”‚                                         â”‚
â”‚                   â–¼                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  ğŸŒ Gemini FileSearch API Call                    â”‚    â”‚
â”‚  â”‚                                                    â”‚    â”‚
â”‚  â”‚  1. Build FileSearch request:                     â”‚    â”‚
â”‚  â”‚     - Query + conversation history                â”‚    â”‚
â”‚  â”‚     - System instruction                          â”‚    â”‚
â”‚  â”‚     - FileSearchStoreNames                        â”‚    â”‚
â”‚  â”‚                                                    â”‚    â”‚
â”‚  â”‚  2. API call to Gemini:                           â”‚    â”‚
â”‚  â”‚     POST /generateContent                         â”‚    â”‚
â”‚  â”‚     Latency: 15-20s â³                            â”‚    â”‚
â”‚  â”‚                                                    â”‚    â”‚
â”‚  â”‚  3. Parse response:                               â”‚    â”‚
â”‚  â”‚     - Extract answer text                         â”‚    â”‚
â”‚  â”‚     - Extract citations                           â”‚    â”‚
â”‚  â”‚     - Format FileSearchSources                    â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                   â”‚                                         â”‚
â”‚                   â–¼                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  ğŸ’¾ Write-through caching:                        â”‚    â”‚
â”‚  â”‚                                                    â”‚    â”‚
â”‚  â”‚  Parallel writes (async):                         â”‚    â”‚
â”‚  â”‚  â”œâ”€ L1: fileSearchExactCache.set()               â”‚    â”‚
â”‚  â”‚  â”œâ”€ L2: semanticCache.store()                    â”‚    â”‚
â”‚  â”‚  â””â”€ L3: persistentCache.store()                  â”‚    â”‚
â”‚  â”‚                                                    â”‚    â”‚
â”‚  â”‚  (Non-blocking for user response)                â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â–¼
                  Response to User
                  Total Time: 15-20s
                  (First time only!)
```

**Key Characteristics**:
- ğŸŒ Slowest path (inevitable for new queries)
- ğŸ“ Populates all cache layers
- ğŸ”„ Future requests will be fast

---

## 2. Cache Invalidation Flow

### 2.1 Document Upload Invalidation

```
Document Upload Event
     â”‚
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      CacheInvalidationService                              â”‚
â”‚      .invalidateOnDocumentUpload()                         â”‚
â”‚                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  Step 1: L1 (InMemory) Full Clear                 â”‚    â”‚
â”‚  â”‚  â”œâ”€ fileSearchExactCache.clear()                  â”‚    â”‚
â”‚  â”‚  â””â”€ Latency: <1ms                                 â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                   â”‚                                         â”‚
â”‚                   â–¼                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  Step 2: L2 (Redis) Pattern Delete                â”‚    â”‚
â”‚  â”‚  â”œâ”€ SCAN pattern: filesearch:semantic:*           â”‚    â”‚
â”‚  â”‚  â”œâ”€ DEL all matching keys                         â”‚    â”‚
â”‚  â”‚  â””â”€ Latency: 10-50ms (depending on cache size)    â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                   â”‚                                         â”‚
â”‚                   â–¼                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  Step 3: L3 (Firestore) Batch Delete (Async)      â”‚    â”‚
â”‚  â”‚  â”œâ”€ Query: collection('filesearch_cache')         â”‚    â”‚
â”‚  â”‚  â”œâ”€ Batch delete in chunks of 500                 â”‚    â”‚
â”‚  â”‚  â””â”€ Latency: 1-5s (background, non-blocking)      â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â–¼
             All caches cleared
             Next FileSearch will be fresh
```

**Trigger Events**:
1. âœ… Document upload to FileSearchStore
2. âœ… Document deletion
3. âœ… Manual admin invalidation

---

### 2.2 User Settings Change Invalidation

```
User Settings Update Event
(PersonalityPreset or MBTI change)
     â”‚
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      CacheInvalidationService                              â”‚
â”‚      .invalidateUserCache(userId)                          â”‚
â”‚                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  Step 1: L1 System Prompt Cache Clear             â”‚    â”‚
â”‚  â”‚  â”œâ”€ systemPromptCache.delete(userId)              â”‚    â”‚
â”‚  â”‚  â””â”€ Latency: <1ms                                 â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                   â”‚                                         â”‚
â”‚                   â–¼                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  Step 2: User's FileSearch Cache Clear            â”‚    â”‚
â”‚  â”‚  (All conversations owned by user)                â”‚    â”‚
â”‚  â”‚                                                    â”‚    â”‚
â”‚  â”‚  â”œâ”€ Get user's conversation IDs                   â”‚    â”‚
â”‚  â”‚  â”œâ”€ For each conversation:                        â”‚    â”‚
â”‚  â”‚  â”‚   â”œâ”€ Clear L1 conversation cache              â”‚    â”‚
â”‚  â”‚  â”‚   â”œâ”€ Delete L2 Redis keys                     â”‚    â”‚
â”‚  â”‚  â”‚   â””â”€ Mark L3 Firestore entries as stale       â”‚    â”‚
â”‚  â”‚  â””â”€ Latency: 10-100ms                             â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â–¼
          User-specific caches cleared
          System prompt will regenerate
```

**Trigger Events**:
1. âœ… PersonalityPreset selection change
2. âœ… MBTI profile update
3. âœ… User preference modifications

---

## 3. Cache Warming Flow

### 3.1 Application Startup Warming

```
Application Startup
     â”‚
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      CacheWarmingService.onModuleInit()                    â”‚
â”‚                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  Step 1: Fetch Popular Queries                    â”‚    â”‚
â”‚  â”‚  â”œâ”€ L3.getPopularQueries(100)                     â”‚    â”‚
â”‚  â”‚  â”œâ”€ ORDER BY accessCount DESC                     â”‚    â”‚
â”‚  â”‚  â””â”€ Result: [query1, query2, ..., query100]       â”‚    â”‚
â”‚  â”‚     Latency: 100-200ms                            â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                   â”‚                                         â”‚
â”‚                   â–¼                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  Step 2: Parallel Cache Loading                   â”‚    â”‚
â”‚  â”‚  (10 queries at a time)                           â”‚    â”‚
â”‚  â”‚                                                    â”‚    â”‚
â”‚  â”‚  For each query batch:                            â”‚    â”‚
â”‚  â”‚  â”œâ”€ Load result from L3 (Firestore)              â”‚    â”‚
â”‚  â”‚  â”œâ”€ Check TTL validity                            â”‚    â”‚
â”‚  â”‚  â”œâ”€ Store in L2 (Redis semantic cache)           â”‚    â”‚
â”‚  â”‚  â””â”€ L1 will auto-populate on first request       â”‚    â”‚
â”‚  â”‚                                                    â”‚    â”‚
â”‚  â”‚  Latency per batch: 50-100ms                      â”‚    â”‚
â”‚  â”‚  Total time: ~1-2s (non-blocking)                 â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                   â”‚                                         â”‚
â”‚                   â–¼                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  Step 3: Background Completion                     â”‚    â”‚
â”‚  â”‚  â”œâ”€ Continue warming remaining queries            â”‚    â”‚
â”‚  â”‚  â”œâ”€ Log completion status                         â”‚    â”‚
â”‚  â”‚  â””â”€ "Cache warmup completed: 95/100 loaded"       â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â–¼
              L2 cache pre-populated
              First user requests are fast!
```

**Benefits**:
- ğŸš€ Eliminates cold start for popular queries
- â±ï¸ Background process (doesn't delay startup)
- ğŸ“Š Data-driven (based on actual usage)

---

### 3.2 Background Cache Refresh

```
Periodic Check (Every 1 hour)
     â”‚
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      CacheWarmingService.refreshExpiring()                 â”‚
â”‚                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  Step 1: Identify Expiring Entries                â”‚    â”‚
â”‚  â”‚  â”œâ”€ L2.getExpiringKeys(threshold: 5min)           â”‚    â”‚
â”‚  â”‚  â”œâ”€ Filter: expiresAt - now < 300000ms            â”‚    â”‚
â”‚  â”‚  â””â”€ Result: [key1, key2, ..., keyN]               â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                   â”‚                                         â”‚
â”‚                   â–¼                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  Step 2: For Each Expiring Key                    â”‚    â”‚
â”‚  â”‚                                                    â”‚    â”‚
â”‚  â”‚  For key in expiringKeys:                         â”‚    â”‚
â”‚  â”‚  â”œâ”€ Retrieve original query + options             â”‚    â”‚
â”‚  â”‚  â”œâ”€ Call FileSearch API (background)              â”‚    â”‚
â”‚  â”‚  â”‚   Latency: 15-20s                              â”‚    â”‚
â”‚  â”‚  â”œâ”€ Update all cache layers:                      â”‚    â”‚
â”‚  â”‚  â”‚   â”œâ”€ L1.store(key, result)                     â”‚    â”‚
â”‚  â”‚  â”‚   â”œâ”€ L2.store(query, result)                   â”‚    â”‚
â”‚  â”‚  â”‚   â””â”€ L3.store(query, result, ttl)              â”‚    â”‚
â”‚  â”‚  â””â”€ Log: "Refreshed cache: {key}"                 â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                   â”‚                                         â”‚
â”‚                   â–¼                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  Step 3: Rate Limiting                             â”‚    â”‚
â”‚  â”‚  â”œâ”€ Max 10 refreshes per cycle                    â”‚    â”‚
â”‚  â”‚  â””â”€ Prevents API quota exhaustion                 â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â–¼
           Cache entries refreshed
           Users never hit cold cache!
```

**Benefits**:
- ğŸ”„ Proactive cache maintenance
- ğŸ¯ Prevents cache expiry for hot queries
- ğŸ’¡ Transparent to users

---

## 4. Semantic Similarity Search Deep Dive

### 4.1 Query Embedding Process

```
User Query: "æ–°äººç ”ä¿®ã®ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«"
     â”‚
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      SemanticCacheService.embedQuery()                     â”‚
â”‚                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  Google Text Embedding API                        â”‚    â”‚
â”‚  â”‚  Model: text-embedding-005                        â”‚    â”‚
â”‚  â”‚                                                    â”‚    â”‚
â”‚  â”‚  Input: "æ–°äººç ”ä¿®ã®ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«"                    â”‚    â”‚
â”‚  â”‚  Output: [0.123, -0.456, 0.789, ..., 0.321]      â”‚    â”‚
â”‚  â”‚          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^          â”‚    â”‚
â”‚  â”‚          768-dimensional vector                    â”‚    â”‚
â”‚  â”‚                                                    â”‚    â”‚
â”‚  â”‚  Latency: 50-100ms                                â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                   â”‚                                         â”‚
â”‚                   â–¼                                         â”‚
â”‚             Float32 Vector                                  â”‚
â”‚             [768 dimensions]                                â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â–¼
           Vector ready for similarity search
```

---

### 4.2 RediSearch Vector Similarity Query

```
Query Vector: [0.123, -0.456, 0.789, ..., 0.321]
     â”‚
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      Redis Vector Similarity Search (HNSW)                 â”‚
â”‚                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  FT.SEARCH Command:                                â”‚    â”‚
â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€     â”‚    â”‚
â”‚  â”‚  FT.SEARCH filesearch:semantic:idx                â”‚    â”‚
â”‚  â”‚    "*=>[KNN 5 @query_embedding $query_vec         â”‚    â”‚
â”‚  â”‚        AS score]"                                  â”‚    â”‚
â”‚  â”‚    PARAMS 2 query_vec <768-float-buffer>          â”‚    â”‚
â”‚  â”‚    SORTBY score ASC                                â”‚    â”‚
â”‚  â”‚    RETURN 3 query_text result score                â”‚    â”‚
â”‚  â”‚    DIALECT 2                                       â”‚    â”‚
â”‚  â”‚                                                    â”‚    â”‚
â”‚  â”‚  Latency: 2-5ms (HNSW approximate search)         â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                   â”‚                                         â”‚
â”‚                   â–¼                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  Top 5 Similar Results:                            â”‚    â”‚
â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€    â”‚    â”‚
â”‚  â”‚  1. "æ–°å…¥ç¤¾å“¡ã®ç ”ä¿®äºˆå®š"   (score: 0.05, sim: 0.95)â”‚    â”‚
â”‚  â”‚  2. "æ–°äººç ”ä¿®ã®ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«" (score: 0.10, sim: 0.90)â”‚    â”‚
â”‚  â”‚  3. "ç ”ä¿®ãƒ—ãƒ­ã‚°ãƒ©ãƒ "        (score: 0.15, sim: 0.85)â”‚    â”‚
â”‚  â”‚  4. "ã‚ªãƒªã‚¨ãƒ³ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³æ—¥ç¨‹"(score: 0.20, sim: 0.80)â”‚    â”‚
â”‚  â”‚  5. "å…¥ç¤¾å¾Œã®äºˆå®š"          (score: 0.25, sim: 0.75)â”‚    â”‚
â”‚  â”‚                                                    â”‚    â”‚
â”‚  â”‚  (score = cosine distance, similarity = 1-score) â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                   â”‚                                         â”‚
â”‚                   â–¼                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  Threshold Check (0.92)                            â”‚    â”‚
â”‚  â”‚  â”œâ”€ Top result similarity: 0.95 > 0.92 âœ…         â”‚    â”‚
â”‚  â”‚  â””â”€ Return cached result from top match           â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â–¼
              Cache HIT with semantic match!
```

**Key Algorithm**:
- ğŸ§® **HNSW** (Hierarchical Navigable Small World): è¿‘ä¼¼æœ€è¿‘å‚æ¢ç´¢
- ğŸ“ **Cosine Distance**: ãƒ™ã‚¯ãƒˆãƒ«é–“ã®è§’åº¦ã§é¡ä¼¼åº¦æ¸¬å®š
- âš¡ **Sub-10ms**: ã‚¤ãƒ³ãƒ¡ãƒ¢ãƒªã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã®é«˜é€Ÿæ€§

---

## 5. Performance Optimization Patterns

### 5.1 Cache Stampede Prevention (Mutex Lock)

```
Concurrent Requests (Same Query)
     â”‚
     â”œâ”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”
     â–¼     â–¼     â–¼     â–¼     â–¼
   Req1  Req2  Req3  Req4  Req5
     â”‚     â”‚     â”‚     â”‚     â”‚
     â””â”€â”€â”€â”€â”€â”´â”€â”€â”¬â”€â”€â”´â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”˜
              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      EnhancedInMemoryCacheService                          â”‚
â”‚      .getOrCreateFileSearchAnswer()                        â”‚
â”‚                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  Step 1: Cache Check (All requests)                â”‚    â”‚
â”‚  â”‚  â”œâ”€ All 5 requests check cache simultaneously     â”‚    â”‚
â”‚  â”‚  â””â”€ Result: MISS (empty cache)                    â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                   â”‚                                         â”‚
â”‚                   â–¼                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  Step 2: Mutex Lock Acquisition                   â”‚    â”‚
â”‚  â”‚                                                    â”‚    â”‚
â”‚  â”‚  Req1: mutex.acquire(cacheKey) âœ… GRANTED         â”‚    â”‚
â”‚  â”‚  Req2: mutex.acquire(cacheKey) â³ WAITING         â”‚    â”‚
â”‚  â”‚  Req3: mutex.acquire(cacheKey) â³ WAITING         â”‚    â”‚
â”‚  â”‚  Req4: mutex.acquire(cacheKey) â³ WAITING         â”‚    â”‚
â”‚  â”‚  Req5: mutex.acquire(cacheKey) â³ WAITING         â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                   â”‚                                         â”‚
â”‚                   â–¼                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  Step 3: Req1 Executes FileSearch API             â”‚    â”‚
â”‚  â”‚  â”œâ”€ FileSearch API call (15-20s)                  â”‚    â”‚
â”‚  â”‚  â”œâ”€ Store result in cache                         â”‚    â”‚
â”‚  â”‚  â””â”€ Release lock                                   â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                   â”‚                                         â”‚
â”‚                   â–¼                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  Step 4: Req2-5 Resume (after lock released)      â”‚    â”‚
â”‚  â”‚                                                    â”‚    â”‚
â”‚  â”‚  Req2: Double-check cache â†’ âœ… HIT! (instant)     â”‚    â”‚
â”‚  â”‚  Req3: Double-check cache â†’ âœ… HIT! (instant)     â”‚    â”‚
â”‚  â”‚  Req4: Double-check cache â†’ âœ… HIT! (instant)     â”‚    â”‚
â”‚  â”‚  Req5: Double-check cache â†’ âœ… HIT! (instant)     â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â–¼
        Result: 1 API call instead of 5!
        Cost reduction: 80%
```

**Benefits**:
- ğŸ’° **Cost Reduction**: åŒæ™‚ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’1å›ã®APIå‘¼ã³å‡ºã—ã«çµ±åˆ
- âš¡ **Latency Improvement**: Req2-5ã¯å³åº§ã«ãƒ¬ã‚¹ãƒãƒ³ã‚¹
- ğŸ”’ **Thread-Safe**: ç«¶åˆçŠ¶æ…‹ã‚’é˜²æ­¢

---

### 5.2 Write-Through vs Write-Back Strategy

```
                Write-Through (Current)
                        â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       â–¼                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  FileSearch API Call (15-20s)       â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                â”‚                              â”‚
â”‚                â–¼                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  Parallel Cache Writes:             â”‚    â”‚
â”‚  â”‚  â”œâ”€ L1.store() (async)              â”‚    â”‚
â”‚  â”‚  â”œâ”€ L2.store() (async)              â”‚    â”‚
â”‚  â”‚  â””â”€ L3.store() (async)              â”‚    â”‚
â”‚  â”‚                                      â”‚    â”‚
â”‚  â”‚  User waits for: 15-20s              â”‚    â”‚
â”‚  â”‚  (API call time only)                â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


                Write-Back (Optimized)
                        â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       â–¼                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  L2 Cache Hit (5-10ms)              â”‚    â”‚
â”‚  â”‚  (Semantic similarity match)         â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                â”‚                              â”‚
â”‚                â–¼                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  Write-Back to L1:                  â”‚    â”‚
â”‚  â”‚  â”œâ”€ L1.store(key, result)           â”‚    â”‚
â”‚  â”‚  â””â”€ Instant promotion (<1ms)        â”‚    â”‚
â”‚  â”‚                                      â”‚    â”‚
â”‚  â”‚  User waits for: 5-10ms              â”‚    â”‚
â”‚  â”‚  (L2 query + L1 write)               â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Strategy Selection**:
- **Write-Through**: Cold cache population (L1 â†’ L2 â†’ L3 simultaneously)
- **Write-Back**: Hot cache optimization (L2 â†’ L1 promotion only)

---

## 6. Monitoring & Observability Flow

```
User Request â†’ Cache Layers â†’ Response
     â”‚              â”‚             â”‚
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           CacheMetricsService.recordCacheAccess()          â”‚
â”‚                                                             â”‚
â”‚  Metrics Collected:                                        â”‚
â”‚  â”œâ”€ cache_l1_hit_rate                                     â”‚
â”‚  â”œâ”€ cache_l2_hit_rate                                     â”‚
â”‚  â”œâ”€ cache_l3_hit_rate                                     â”‚
â”‚  â”œâ”€ cache_l1_latency_ms                                   â”‚
â”‚  â”œâ”€ cache_l2_latency_ms                                   â”‚
â”‚  â”œâ”€ cache_l3_latency_ms                                   â”‚
â”‚  â”œâ”€ semantic_similarity_score                             â”‚
â”‚  â””â”€ filesearch_api_latency_ms                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚               Google Cloud Monitoring                      â”‚
â”‚                                                             â”‚
â”‚  Real-time Dashboards:                                     â”‚
â”‚  â”œâ”€ Cache Hit Rate Trends                                 â”‚
â”‚  â”œâ”€ Latency Percentiles (p50/p95/p99)                     â”‚
â”‚  â”œâ”€ Popular Queries List                                  â”‚
â”‚  â””â”€ Cost Savings Metrics                                  â”‚
â”‚                                                             â”‚
â”‚  Alerts:                                                   â”‚
â”‚  â”œâ”€ Cache hit rate < 80% â†’ Investigate                    â”‚
â”‚  â”œâ”€ L2 latency > 20ms â†’ Check Redis performance           â”‚
â”‚  â””â”€ FileSearch API errors > 5% â†’ Escalate                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 7. Error Handling & Fallback

```
User Request
     â”‚
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Layered Error Handling                         â”‚
â”‚                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  Try L1 Cache                                      â”‚    â”‚
â”‚  â”‚  â”œâ”€ Error: None (in-memory, reliable)             â”‚    â”‚
â”‚  â”‚  â””â”€ Fallback: L2                                   â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                   â”‚                                         â”‚
â”‚                   â–¼                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  Try L2 Cache (Redis)                             â”‚    â”‚
â”‚  â”‚  â”œâ”€ Possible Errors:                               â”‚    â”‚
â”‚  â”‚  â”‚   â€¢ Connection timeout                          â”‚    â”‚
â”‚  â”‚  â”‚   â€¢ Redis instance unavailable                  â”‚    â”‚
â”‚  â”‚  â”‚   â€¢ Embedding API failure                       â”‚    â”‚
â”‚  â”‚  â”œâ”€ Error Handling:                                â”‚    â”‚
â”‚  â”‚  â”‚   â€¢ Log warning                                 â”‚    â”‚
â”‚  â”‚  â”‚   â€¢ Skip L2, continue to L3                    â”‚    â”‚
â”‚  â”‚  â””â”€ Fallback: L3                                   â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                   â”‚                                         â”‚
â”‚                   â–¼                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  Try L3 Cache (Firestore)                         â”‚    â”‚
â”‚  â”‚  â”œâ”€ Possible Errors:                               â”‚    â”‚
â”‚  â”‚  â”‚   â€¢ Firestore query timeout                     â”‚    â”‚
â”‚  â”‚  â”‚   â€¢ Permission denied                           â”‚    â”‚
â”‚  â”‚  â”œâ”€ Error Handling:                                â”‚    â”‚
â”‚  â”‚  â”‚   â€¢ Log error                                   â”‚    â”‚
â”‚  â”‚  â”‚   â€¢ Skip L3, continue to FileSearch API        â”‚    â”‚
â”‚  â”‚  â””â”€ Fallback: FileSearch API                       â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                   â”‚                                         â”‚
â”‚                   â–¼                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  FileSearch API (Ultimate Fallback)               â”‚    â”‚
â”‚  â”‚  â”œâ”€ Possible Errors:                               â”‚    â”‚
â”‚  â”‚  â”‚   â€¢ API quota exceeded                          â”‚    â”‚
â”‚  â”‚  â”‚   â€¢ Network timeout                             â”‚    â”‚
â”‚  â”‚  â”‚   â€¢ Invalid request                             â”‚    â”‚
â”‚  â”‚  â”œâ”€ Error Handling:                                â”‚    â”‚
â”‚  â”‚  â”‚   â€¢ Retry with exponential backoff (3 attempts)â”‚    â”‚
â”‚  â”‚  â”‚   â€¢ If all retries fail:                       â”‚    â”‚
â”‚  â”‚  â”‚     â†’ Return friendly error message to user    â”‚    â”‚
â”‚  â”‚  â””â”€ Final Fallback: Error response                 â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â–¼
                Response or Error
```

**Resilience Strategy**:
- ğŸ›¡ï¸ **Graceful Degradation**: Each layer failure falls back to next
- ğŸ”„ **Retry Logic**: FileSearch API retries with exponential backoff
- ğŸ“ **Comprehensive Logging**: All errors tracked for analysis
- ğŸ‘¤ **User-Friendly Messages**: Technical errors translated to friendly messages

---

**Document Version**: 1.0
**Last Updated**: 2025-12-19
**Author**: System Architecture Designer
